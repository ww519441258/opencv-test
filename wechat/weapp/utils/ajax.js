"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.apiBaseUrl=void 0;var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},request=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,a,s,i,o,u,c,d,f,l,p,g;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.api,n=t.name,a=t.data,s=void 0===a?{}:a,i=t.success,o=t.fail,u=t.hintText,c=t.disableCache,d=t.hideToast,f=s||null,l=baseURL+"/"+r.url,p={},!r.needAccessToken){e.next=10;break}if(accessToken){e.next=9;break}if(accessToken=getStorage("access-token")){e.next=9;break}return e.abrupt("return",loginAndRetry({api:r,data:s,success:i,fail:o,hintText:u}));case 9:p={"access-token":accessToken};case 10:return"GET"!==r.method&&"DELETE"!==r.method||(p=_extends({},p,s),f=null),null!==p&&"{}"!==JSON.stringify(p)&&(l+="?"+_index4.default.stringify(p)),e.prev=12,e.next=15,_index2.default.request({url:l,data:f,header:_extends({"Content-Type":"application/x-www-form-urlencoded"},r.header),method:r.method.toUpperCase()});case 15:return g=e.sent,"WEAPP"===_index2.default.getEnv()&&_index2.default.stopPullDownRefresh(),e.abrupt("return",handleSuccess({res:g,api:r,name:n,data:s,success:i,fail:o,hintText:u,disableCache:c,hideToast:d}));case 20:return e.prev=20,e.t0=e.catch(12),e.abrupt("return",handleFail(e.t0,t));case 23:case"end":return e.stop()}},e,this,[[12,20]])}));return function(e){return t.apply(this,arguments)}}(),loginForAjax=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n,a,s,i,o,u,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(isLoggingIn)return e.abrupt("return",Promise.reject("There are a login task is running."));e.next=4;break;case 4:return isLoggingIn=!0,retryCount++,e.prev=6,e.next=9,(0,_index7.login)();case 9:if(t=e.sent,r=t.access_token,2!==t.status||"WEAPP"!==_index2.default.getEnv()){e.next=25;break}_index2.default.setStorageSync("isRegistered",0),n=_index2.default.getCurrentPages(),a=n&&n[n.length-1]||{},s=a.route,i=void 0===s?"pages/index/index":s,o=a.options,u=void 0===o?{}:o,accessToken=r,isLoggingIn=!1,"pages/record-user-info/record-user-info",c=(0,_navigation.isTabbar)(i),"pages/record-user-info/record-user-info"!==i&&_index2.default.setStorageSync("startPath",{path:i,params:u}),c&&_index2.default.hideTabBar(),_index2.default.reLaunch({url:"/pages/record-user-info/record-user-info"}),e.next=28;break;case 25:return saveAccessToken(r),isLoggingIn=!1,e.abrupt("return",accessToken);case 28:e.next=34;break;case 30:return e.prev=30,e.t0=e.catch(6),isLoggingIn=!1,e.abrupt("return",new Error("登录失败("+e.t0+")"));case 34:case"end":return e.stop()}},e,this,[[6,30]])}));return function(){return e.apply(this,arguments)}}(),loginAndRetry=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(n){var a=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(MAX_NUMBER_OF_RETRIES<=retryCount)return e.abrupt("return",(0,_helper.showInfo)("登录失败，请退出重新进入"));e.next=4;break;case 4:return e.abrupt("return",new Promise(function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(retryList.push({args:n,resolve:t,reject:r}),isLoggingIn){e.next=6;break}return e.next=4,loginForAjax();case 4:retryList.forEach(function(e){var t=e.args,r=e.resolve,n=e.reject;request(t).then(r).catch(n)}),retryList=[];case 6:case"end":return e.stop()}},e,a)}));return function(e,t){return r.apply(this,arguments)}}()));case 5:case"end":return e.stop()}},e,this)}));return function(e){return t.apply(this,arguments)}}();exports.setConfig=setConfig;var _index=require("../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_index3=require("../npm/qs/lib/index.js"),_index4=_interopRequireDefault(_index3),_index5=require("../api/index.js"),_index6=_interopRequireDefault(_index5),_kcshopConfig=require("../kcshop.config.js"),_kcshopConfig2=_interopRequireDefault(_kcshopConfig),_helper=require("./helper.js"),_index7=require("./compatibility/index.js"),_navigation=require("./navigation.js");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var o=e.apply(this,arguments);return new Promise(function(s,i){return function t(e,r){try{var n=o[e](r),a=n.value}catch(e){return void i(e)}if(!n.done)return Promise.resolve(a).then(function(e){t("next",e)},function(e){t("throw",e)});s(a)}("next")})}}var MAX_NUMBER_OF_RETRIES=5,logPrefix="taro-ajax",apiSet=_index6.default,baseURL=void 0,extConfig=_index2.default.getExtConfigSync();baseURL="WEAPP"===_index2.default.getEnv()&&extConfig.apiBaseURL?extConfig.apiBaseURL:"WEAPP"===_index2.default.getEnv()||"<"===window.apiBase.charAt(0)?_kcshopConfig2.default.APIBaseURL:window.apiBase,"WEB"===_index2.default.getEnv()&&"<"===window.openid.charAt(0)&&(window.openid="oyGspwEzhXLGYmx_8IWd5BfgnYRs");var accessToken="",retryCount=0,isLoggingIn=!1,retryList=[];function getStorage(e){return _index2.default.getStorageSync(e)}function setStorage(t,r){try{_index2.default.setStorageSync(t,r)}catch(e){_index2.default.clearStorageSync(),_index2.default.setStorageSync(t,r)}}function handleImageSrc(e){var t=JSON.stringify(e);return t=t.replace(/"\/(uploads|img|ueditor)\//g,'"'+baseURL+"/$1/"),JSON.parse(t)}function getCorrectData(e){var t=e;if("string"==typeof e)try{t=JSON.parse(e)}catch(e){return null}else if("object"!==(void 0===e?"undefined":_typeof(e)))return null;return(t=handleImageSrc(t)).data&&void 0!==t.status&&(t=t.data),t}function RequestException(e,t,r){this.type="RequestException",this.statusCode=e.statusCode,this.message=t,this.code=r}function handleSuccess(e){var t=e.res,r=e.api,n=e.name,a=e.success,s=e.hintText;if(t.data){if(200!==t.statusCode)throw t;var i=t.data.status;if(r.ignoreStatus||-1!==i||!0===i||void 0===i){var o=getCorrectData(t.data);if(o)return 0<r.maxAge&&setStorage(n,{time:(new Date).valueOf(),data:o}),s&&(0,_helper.showSuccess)(s+"成功"),a&&a(o),o;throw(0,_helper.showInfo)(n+" 接口返回数据结构错误: "+t.data),new RequestException(t,t.data.info,t.data.status)}throw t.data.info?new RequestException(t,t.data.info,t.data.status):t.data.errorMsg?new RequestException(t,t.data.errorMsg,t.data.status):new RequestException(t,"操作失败，请稍后重试",t.data.status)}throw new RequestException(t,"服务器没有返回数据，请稍后重试")}function handleFail(e,t){var r=t.fail,n=t.hintText,a=t.hideToast,s={"request:fail url not in domain list":{type:"配置错误",message:"当前 API 域名（"+baseURL+"）不允许访问，请在微信公众平台设置服务器域名"},"uploadFile:fail url not in domain list":{type:"配置错误",message:"当前上传域名（"+baseURL+"）不允许访问，请在微信公众平台设置上传域名"}},i="error",o=e,u=void 0;if(e instanceof RequestException)r&&r(_extends({},e,{code:e.code,info:e.message})),i="info",o=e.message;else if("string"==typeof e)o=e;else if(e.stack)o=e.message+"（"+e.stack+"）",u="JavaScript 错误";else if(401===e.statusCode){if(retryCount<=5)return loginAndRetry(t);o="登录失败，请退出重新进入"}else if(e.data&&e.data.info)i="info",o=e.data.info;else if(!e.data||!1!==e.data.status&&-1!==e.data.status)if(e.data&&e.data.message)o="("+e.statusCode+"): "+e.data.message,u="服务器错误";else if(e.statusCode)"5"===e.statusCode.toString().charAt(0)?o="服务器错误("+e.statusCode+")":"4"===e.statusCode.toString().charAt(0)&&(o="请求错误("+e.statusCode+")");else if(e.errMsg){var c=s[e.errMsg];c?(o=c.message,u=c.type):o=e.errMsg.startsWith("request:fail")?(u="网络错误","无法连接到互联网，或者网络过慢导致连接超时，请检查网络连接"):(u="其它错误","其它错误("+e.errMsg+")")}else o="其它错误("+JSON.stringify(e)+")";else i="info",o=(n||"操作")+"失败";throw"error"===i?(0,_helper.showError)(o,u):a||(0,_helper.showInfo)(o),o}function saveAccessToken(e){e&&(accessToken=e,_index2.default.setStorageSync("access-token",accessToken))}function ajax(e){var t=e.name,r=e.data,n=e.success,a=e.fail,s=e.hintText,i=e.disableCache,o=void 0!==i&&i,u=e.hideToast,c=void 0!==u&&u,d=apiSet[t];if(!d){var f=logPrefix+' 未能在 apiSet 中找到 "'+t+'"';throw"WEAPP"===_index2.default.getEnv()&&(0,_helper.showError)(f),new Error(f)}if(!(!o&&d.maxAge&&0<d.maxAge))return request({api:d,name:t,data:r,success:n,fail:a,hintText:s,disableCache:o,hideToast:c});var l=getStorage(t);l&&new Date-l.time<=60*d.maxAge*1e3&&n&&n(l.data)}function setConfig(e){e&&e.baseURL&&(baseURL=e.baseURL),e&&e.apiSet&&(apiSet=e.apiSet)}exports.default=ajax;var apiBaseUrl=exports.apiBaseUrl=baseURL;