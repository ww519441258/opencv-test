"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(e,t){"object"==("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.XbossDebug=t()}(void 0,function(){var u={typeDecide:function(e,t){return Object.prototype.toString.call(e)==="[object "+t+"]"},isFunction:function(e){return u.typeDecide(e,"Function")},isString:function(e){return u.typeDecide(e,"String")},serializeObj:function(t){var n="";return Object.keys(t).forEach(function(e){u.typeDecide(t[e],"Object")?n+=e+"="+JSON.stringify(t[e]):n+=e+"="+t[e]+"^"}),encodeURIComponent(n.substr(0,n.length-1))},noop:function(){},now:function(){return(new Date).getTime()}},o=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},r=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),i=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":_typeof(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},c=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":_typeof(t))&&"function"!=typeof t?e:t},n=function(){function t(e){o(this,t),this.config={version:"1.0.0",setSystemInfo:!1,setLocation:!1,key:"",mergeReport:!0,delay:1e3,url:"",except:[/^Script error\.?/,/^Javascript error: Script error\.? on line 0/],random:1,repeat:5},this.config=Object.assign(this.config,e)}return r(t,[{key:"get",value:function(e){return this.config[e]}},{key:"set",value:function(e,t){return this.config[e]=t,this.config[e]}}]),t}(),s=function(){function e(){o(this,e),this.handlers={}}return r(e,[{key:"on",value:function(e,t){return this.handlers[e]=this.handlers[e]||[],this.handlers[e].push(t),this.handlers[e]}},{key:"off",value:function(e){this.handlers[e]&&delete this.handlers[e]}},{key:"trigger",value:function(e,t){var n=this,r=t||[],o=this.handlers[e];return!o||o.every(function(e){return!1!==e.apply(n,r)})}}]),e}(),t=function(e){function t(e){o(this,t);var r=c(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r.errorQueue=[],r.repeatList={},r.config=(new n).config,["log","debug","info","warn","error"].forEach(function(t,n){r[t]=function(e){return r.handleMsg(e,t,n)}}),r}return i(t,s),r(t,[{key:"setOptions",value:function(e){Object.assign(this.config,e)}},{key:"repeat",value:function(e){var t=e.rowNum||"",n=e.colNum||"",r=e.msg+t+n;return this.repeatList[r]=this.repeatList[r]?this.repeatList[r]+1:1,this.repeatList[r]>this.config.repeat}},{key:"except",value:function(e){var t=this.config.except,n=!1,r=null;if(u.typeDecide(t,"Array"))for(var o=0,i=t.length;o<i;o++)if(r=t[o],u.typeDecide(r,"RegExp")&&r.test(e.msg)){n=!0;break}return n}},{key:"request",value:function(e,t,n){if(!this.config.key)throw new Error("please set key in xbossdebug.config.key");t.key=this.config.key,wx.request({url:e,method:"POST",data:t,success:n})}},{key:"report",value:function(e){var t=this,n=this.config.mergeReport;if(0===this.errorQueue.length)return this.config.url;var r=n?this.errorQueue:[this.errorQueue.shift()];n&&(this.errorQueue=[]);var o=this.config.url,i={error:r,systemInfo:this.systemInfo,breadcrumbs:this.breadcrumbs,locationInfo:this.locationInfo,networkType:this.networkType,notifierVersion:this.config.version};return this.request(o,i,function(){e&&e.call(t),t.trigger("afterReport")}),o}},{key:"send",value:function(e){var t=this;if(this.trigger("beforeReport")){var n=e||u.noop,r=this.config.mergeReport?this.config.delay:0;setTimeout(function(){t.report(n)},r)}}},{key:"catchError",value:function(e){return!(Math.random()>=this.config.random)&&!this.repeat(e)&&!this.except(e)&&(this.errorQueue.push(e),this.errorQueue)}},{key:"handleMsg",value:function(e,t,n){if(!e)return!1;var r=u.typeDecide(e,"Object")?e:{msg:e};return r.level=n,r.type=t,r.time=Date.now(),this.catchError(r)&&this.send(),r}}]),t}();return new(function(e){function n(e){o(this,n);var t=c(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return t.breadcrumbs=[],t.activePage={},t.rewriteApp(),t.rewritePage(),t}return i(n,t),r(n,[{key:"rewriteApp",value:function(){var t=App,o=this;App=function(e){return["onLaunch","onShow","onHide","onError"].forEach(function(n){var r=e[n];"onLaunch"===n&&(o.getNetworkType(),o.config.setLocation&&o.getLocation(),o.config.setSystemInfo&&o.getSystemInfo()),e[n]=function(e){var t={type:"function",time:u.now(),belong:"App",method:n,path:e&&e.path,query:e&&e.query,scene:e&&e.scene};return o.pushToBreadcrumb(t),"onError"===n&&o.error({msg:e}),r&&r.call(this,e)}}),t(e)}}},{key:"rewritePage",value:function(){var n=this,e=Page;Page=function(t){return Object.keys(t).forEach(function(e){"function"==typeof t[e]&&n.recordPageFn(t,e)}),t.onReady||n.recordPageFn(t,"onReady"),t.onLoad||n.recordPageFn(t,"onLoad"),e(t)}}},{key:"getActivePage",value:function(){var e=getCurrentPages();return e.length?e[e.length-1]:{}}},{key:"pushToBreadcrumb",value:function(e){this.breadcrumbs.push(e),20<this.breadcrumbs.length&&this.breadcrumbs.shift()}},{key:"recordPageFn",value:function(e,t){var n=e[t],r=this;e[t]=function(){"onLoad"!==t&&"onShow"!==t||(r.activePage=r.getActivePage());var e={type:"function",time:u.now(),belong:"Page",method:t,route:r.activePage&&r.activePage.route,options:r.activePage&&r.activePage.options};return"onLoad"===t&&(e.args=arguments),r.methodFilter(t)&&r.pushToBreadcrumb(e),n&&n.apply(this,arguments)}}},{key:"methodFilter",value:function(e){return"onPageScroll"!==e}},{key:"getNetworkType",value:function(){var t=this;wx.getNetworkType({success:function(e){t.networkType=e.networkType}})}},{key:"getSystemInfo",value:function(){var t=this;wx.getSystemInfo({success:function(e){t.systemInfo=e}})}},{key:"getLocation",value:function(){var t=this;wx.getLocation({type:"wgs84",success:function(e){t.locationInfo=e}})}}]),n}())});