"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.apiBaseUrl=void 0;var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],n=!0,a=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(e){a=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(a)throw i}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},request=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,a,i,o,s,u,c,f;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.api,n=t.name,a=t.data,i=void 0===a?{}:a,o=t.hintText,s=t.disableCache,u=t.hideToast,c={},_api.loginApiName===n||!isRequireAccessToken(r.url)){e.next=10;break}if(!accessToken){e.next=7;break}c={Authorization:accessToken},e.next=10;break;case 7:if(accessToken=_index2.default.getStorageSync("access-token")){e.next=10;break}return e.abrupt("return",loginAndRetry(t));case 10:return e.prev=10,e.next=13,_index2.default.request({url:(0,_urlJoin2.default)(baseURL,r.url),data:i,header:_extends({},c,r.header),method:r.method.toUpperCase()});case 13:return f=e.sent,e.abrupt("return",handleSuccess({res:f,api:r,name:n,data:i,hintText:o,disableCache:s,hideToast:u}));case 17:return e.prev=17,e.t0=e.catch(10),e.abrupt("return",handleFail(e.t0,t));case 20:case"end":return e.stop()}},e,this,[[10,17]])}));return function(e){return t.apply(this,arguments)}}(),loginForAjax=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(isLoggingIn)return e.abrupt("return",Promise.reject("There are a login task is running."));e.next=4;break;case 4:return isLoggingIn=!0,retryCount++,e.prev=6,e.next=9,(0,_index5.login)();case 9:return t=e.sent,saveAccessToken(r=t.accessToken),isLoggingIn=!1,e.abrupt("return",r);case 16:return e.prev=16,e.t0=e.catch(6),isLoggingIn=!1,(0,_helper.showError)("登录失败("+(e.t0.errMsg||("object"===(void 0===e.t0?"undefined":_typeof(e.t0))?JSON.stringify(e.t0):e.t0))+")"),e.abrupt("return",new Error("登录失败("+e.t0+")"));case 21:case"end":return e.stop()}},e,this,[[6,16]])}));return function(){return e.apply(this,arguments)}}(),loginAndRetry=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(n){var a=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(MAX_NUMBER_OF_RETRIES<=retryCount)return e.abrupt("return",(0,_helper.showInfo)("登录失败，请退出重新进入"));e.next=4;break;case 4:return e.abrupt("return",new Promise(function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(retryList.push({args:n,resolve:t,reject:r}),isLoggingIn){e.next=6;break}return e.next=4,loginForAjax();case 4:retryList.forEach(function(e){var t=e.args,r=e.resolve,n=e.reject;request(t).then(r).catch(n)}),retryList=[];case 6:case"end":return e.stop()}},e,a)}));return function(e,t){return r.apply(this,arguments)}}()));case 5:case"end":return e.stop()}},e,this)}));return function(e){return t.apply(this,arguments)}}(),ajax=function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r){var n,a,i,o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{hintText:null,disableCache:!1,hideToast:!1},s=o.hintText,u=o.disableCache,c=o.hideToast;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("object"===(void 0===t?"undefined":_typeof(t)))return e.abrupt("return",(0,_ajax2.default)(t));e.next=2;break;case 2:if(n=_index4.default[t])return a=n,e.abrupt("return",!u&&getCache(t,a.maxAge)||request({api:a,name:t,data:r,hintText:s,disableCache:u,hideToast:c}));e.next=8;break;case 8:throw i='未能在 apiSet 中找到 "'+t+'"',(0,_helper.showError)(i),new Error(i);case 11:case"end":return e.stop()}},e,this)}));return function(e,t){return r.apply(this,arguments)}}(),_index=require("../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_urlJoin=require("../npm/url-join/lib/url-join.js"),_urlJoin2=_interopRequireDefault(_urlJoin),_api=require("../services/api.js"),_index3=require("../api/index.js"),_index4=_interopRequireDefault(_index3),_kcshopConfig=require("../kcshop.config.js"),_kcshopConfig2=_interopRequireDefault(_kcshopConfig),_index5=require("./compatibility/index.js"),_ajax=require("./ajax.js"),_ajax2=_interopRequireDefault(_ajax),_helper=require("./helper.js");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var s=e.apply(this,arguments);return new Promise(function(i,o){return function t(e,r){try{var n=s[e](r),a=n.value}catch(e){return void o(e)}if(!n.done)return Promise.resolve(a).then(function(e){t("next",e)},function(e){t("throw",e)});i(a)}("next")})}}var MAX_NUMBER_OF_RETRIES=5,baseURL=null,extConfig=_index2.default.getExtConfigSync()||{};baseURL="WEAPP"===_index2.default.getEnv()&&extConfig.apiBaseURL?extConfig.apiBaseURL:"WEAPP"===_index2.default.getEnv()||"<"===window.apiBase.charAt(0)?_kcshopConfig2.default.APIBaseURL:window.apiBase;var accessToken="",retryCount=0,isLoggingIn=!1,retryList=[];function handleImageSrc(e){var t=JSON.stringify(e);return t=t.replace(/"\/(uploads|img|ueditor)\//g,'"'+(0,_urlJoin2.default)(baseURL,"/$1/")),JSON.parse(t)}function getCorrectData(e){var t=e;if("string"==typeof e)try{t=JSON.parse(e)}catch(e){return null}else if("object"!==(void 0===e?"undefined":_typeof(e)))return null;return(t=handleImageSrc(t)).data&&void 0!==t.status&&(t=t.data),t}function RequestException(e,t,r){this.statusCode=e.statusCode,this.message=t,this.code=r}function saveCache(e,t){_index2.default.setStorageSync(e,{time:(new Date).valueOf(),data:t})}function getCache(e,t){var r=_index2.default.getStorageSync(e);return r&&new Date-r.time<=60*t*1e3?r.data:null}function handleSuccess(e){var t=e.res,r=e.api,n=e.name,a=e.hintText,i=t.data,o=t.statusCode,s=t.ignoreStatus;if(i){if(200!==o)throw t;var u=i.status;if(s||-1!==u||!0===u||void 0===u){var c=getCorrectData(t.data);if(c)return 0<r.maxAge&&saveCache(c),a&&(0,_helper.showSuccess)(a+"成功"),c;throw(0,_helper.showInfo)(n+" 接口返回数据结构错误: "+t.data),new RequestException(t,t.data.info,t.data.status)}throw i.info?new RequestException(t,i.info,i.status):i.errorMsg?new RequestException(t,i.errorMsg,i.status):new RequestException(t,"操作失败，请稍后重试",i.status)}throw new RequestException(t,"服务器没有返回数据，请稍后重试")}function handleFail(e,t){var r=t.fail,n=t.hintText,a=t.hideToast,i={"request:fail url not in domain list":{type:"配置错误",message:"当前 API 域名（"+baseURL+"）不允许访问，请在微信公众平台设置服务器域名"},"uploadFile:fail url not in domain list":{type:"配置错误",message:"当前上传域名（"+baseURL+"）不允许访问，请在微信公众平台设置上传域名"}},o="error",s=e,u=void 0;if(e instanceof RequestException)r&&r(_extends({},e,{code:e.code,info:e.message})),o="info",s=e.message;else if("string"==typeof e)s=e;else if(e.stack)s=e.message+"（"+e.stack+"）",u="JavaScript 错误";else if(401===e.statusCode){if(retryCount<=5)return loginAndRetry(t);s="登录失败，请退出重新进入"}else if(e.data&&e.data.info)o="info",s=e.data.info;else if(!e.data||!1!==e.data.status&&-1!==e.data.status)if(e.data&&e.data.message)s="("+e.statusCode+"): "+e.data.message,u="服务器错误";else if(e.statusCode)"5"===e.statusCode.toString().charAt(0)?s="服务器错误("+e.statusCode+")":"4"===e.statusCode.toString().charAt(0)&&(s="请求错误("+e.statusCode+")");else if(e.errMsg){var c=i[e.errMsg];c?(s=c.message,u=c.type):s=e.errMsg.startsWith("request:fail")?(u="网络错误","无法连接到互联网，或者网络过慢导致连接超时，请检查网络连接"):(u="其它错误","其它错误("+e.errMsg+")")}else s="其它错误("+JSON.stringify(e)+")";else o="info",s=(n||"操作")+"失败";throw"error"===o?(0,_helper.showError)(s,u):a||(0,_helper.showInfo)(s),s}function isRequireAccessToken(t){return _api.controllersNeedAccessToken.some(function(e){return new RegExp("^/"+e+"/?.*$").test(t)})}function saveAccessToken(e){e&&(accessToken=e,_index2.default.setStorageSync("access-token",accessToken))}function getApiInfoFromString(e){var t=e.split(" "),r=_slicedToArray(t,3),n=r[0],a=r[1],i=r[2],o=null;if(t.some(function(e){return""===e})&&" "!==e?o="参数分隔符只能为一个空格，请勿使用两个及两个以上的空格作为参数分隔符":null===n.match(/(GET|POST|PUT|DELETE)/)&&(o="请求方法只能为 GET、POST、PUT、DELETE 中的一个（必须大写）"),o)throw new Error("[API] "+o+"，错误来源：src/services/api.js 中的 “"+e+"” 项");return{method:n,url:a,needAccessToken:"#"===i}}exports.default=ajax;var apiBaseUrl=exports.apiBaseUrl=baseURL;