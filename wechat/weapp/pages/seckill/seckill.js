"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _class,_temp2,_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},_createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}(),_get=function e(t,n,o){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,n);if(void 0===r){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,n,o)}if("value"in r)return r.value;var a=r.get;return void 0!==a?a.call(o):void 0},_index=require("../../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_dayjsMin=require("../../npm/dayjs/dayjs.min.js"),_dayjsMin2=_interopRequireDefault(_dayjsMin),_index3=require("../../npm/classnames/index.js"),_index4=_interopRequireDefault(_index3),_ajax=require("../../utils/ajax.js"),_ajax2=_interopRequireDefault(_ajax),_countdown=require("../../utils/countdown.js"),_countdown2=_interopRequireDefault(_countdown);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var s=e.apply(this,arguments);return new Promise(function(i,a){return function t(e,n){try{var o=s[e](n),r=o.value}catch(e){return void a(e)}if(!o.done)return Promise.resolve(r).then(function(e){t("next",e)},function(e){t("throw",e)});i(r)}("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function formatDate(e){return(0,_dayjsMin2.default)(e).format("YYYY年MM月DD日 HH:mm:ss")}var Seckill=(_temp2=_class=function(e){function a(){var e,t,s,n,u=this;_classCallCheck(this,a);for(var o=arguments.length,r=Array(o),i=0;i<o;i++)r[i]=arguments[i];return(t=s=_possibleConstructorReturn(this,(e=a.__proto__||Object.getPrototypeOf(a)).call.apply(e,[this].concat(r)))).$usedState=["_$hasStarred","_$anonymousState__temp","_$anonymousState__temp2","_$anonymousState__temp3","_$anonymousState__temp4","loopArray22","loopArray23","$compid__100","$compid__101","$compid__102","sessionList","countDown","banner","goodsList","currentSessionIndex"],s.config={navigationBarTitleText:"秒杀活动"},s.timerForCountdown=null,s.timerForCheck=null,s.filterValid=function(e){var t=s.state.sessionList,n=(e||t).filter(function(e){var t=e.end_date_time;return new Date<=new Date(t)});return void 0===e&&n.length<t.length?(_index2.default.showLoading({title:"刷新秒杀中"}),s.setState({sessionList:n,goodsList:null}),s.switchTo(0,n)):e&&n.length<e.length&&s.switchTo(0,n),n},s.countDown=function(e){if(e){s.timerForCountdown&&clearInterval(s.timerForCountdown);var t=e.start_date_time,n=e.end_date_time,o=new Date(t)<=new Date;s.timerForCountdown=(0,_countdown2.default)({time:o?n:t,updatedCallback:function(e,t,n,o){s.setState({countDown:{day:e,hour:t,min:n,sec:o}})}})}},s.getData=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,o,r,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,_ajax2.default)({name:"getSecKillSessions"});case 2:t=e.sent,n=t.activities,o=t.goods,r=n.map(function(e){return _extends({},e,{start_date_time:1e3*e.start_date_time,end_date_time:1e3*e.end_date_time})}),i=s.filterValid(r),s.setState({sessionList:i,goodsList:i.length===r.length?o:null}),s.timerForCheck=setInterval(function(){s.filterValid()},1e3),s.countDown(r[0]);case 10:case"end":return e.stop()}},e,u)})),s.switchTo=(n=_asyncToGenerator(regeneratorRuntime.mark(function e(t,n){var o,r,i,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(o=s.state,r=o.sessionList,i=o.currentSessionIndex,t!==i||n)return s.setState({currentSessionIndex:t,goodsList:null}),s.countDown((n||r)[t]),e.next=6,(0,_ajax2.default)({name:"getSecKillGoods",data:{activityId:(n||r)[t].id}});e.next=8;break;case 6:a=e.sent,s.setState({goodsList:a},function(){return _index2.default.hideLoading()});case 8:case"end":return e.stop()}},e,u)})),function(e,t){return n.apply(this,arguments)}),s.anonymousFunc0Map={},s.customComponents=["SeckillSession","AtCountdown","GoodsCell","Tip","Loading"],_possibleConstructorReturn(s,t)}return _inherits(a,_index.Component),_createClass(a,[{key:"_constructor",value:function(e){_get(a.prototype.__proto__||Object.getPrototypeOf(a.prototype),"_constructor",this).call(this,e),this.state={sessionList:null,goodsList:null,currentSessionIndex:0,countDown:null},this.$$refs=[]}},{key:"componentWillMount",value:function(){this.getData()}},{key:"componentWillUnmount",value:function(){this.timerForCheck&&clearInterval(this.timerForCheck),this.timerForCountdown&&clearInterval(this.timerForCountdown)}},{key:"onShareAppMessage",value:function(){}},{key:"onPullDownRefresh",value:function(){this.setState({sessionList:null}),this.getData()}},{key:"_createData",value:function(){var e,t,n,o,r,i=this;this.__state=arguments[0]||this.state||{},this.__props=arguments[1]||this.props||{};arguments[2];var a=this.$prefix,s=(0,_index.genCompid)(a+"$compid__100"),u=(0,_index.genCompid)(a+"$compid__101"),l=(0,_index.genCompid)(a+"$compid__102"),c=void 0,_=void 0,d=this.__state,p=d.sessionList,m=d.goodsList,f=d.currentSessionIndex,h=d.countDown,g=p&&p[f]&&p[f].banner;if(p&&0<p.length){var y=p[f],v=y.start_date_time,w=y.end_date_time;e=new Date(v)<=new Date,t=(0,_index4.default)("session-list",{around:p.length<=3}),n=formatDate(v),o=formatDate(w),r=h?{day:"天",hours:":",minutes:":",seconds:""}:null,_=p.map(function(e,t){e={$original:(0,_index.internal_get_original)(e)};var n=f===t,o="JsGCH"+t;i.anonymousFunc0Map[o]=function(){return i.switchTo(t)};var r=(0,_index.genCompid)(a+"JNOcgoZtjq"+t);return _index.propsManager.set({seckillInfo:e.$original,width:p.length<=3?100/p.length+"vw":"30vw",active:n,onClick:i.anonymousFunc0.bind(i,o)},r),{start_date_time:v,end_date_time:w,$loopState__temp3:n,_$indexKey:o,$compid__98:r,$original:e.$original}}),c=m&&0<m.length?m.map(function(e,t){e={$original:(0,_index.internal_get_original)(e)};var n=(0,_index.genCompid)(a+"ubdKsnnKLJ"+t);return m&&0<m.length&&_index.propsManager.set({goods:e.$original},n),{start_date_time:v,end_date_time:w,$compid__99:n,$original:e.$original}}):[],h&&_index.propsManager.set({isShowDay:!0,isCard:!0,format:r,day:h.day,hours:h.hours,minutes:h.min,seconds:h.sec},s),!(m&&0<m.length)&&m&&_index.propsManager.set({text:"该场秒杀没有商品",mainAction:""},u)}else p&&_index.propsManager.set({mainActionType:"home",mainAction:"返回首页",text:"暂无秒杀活动",height:"100vh"},l);return Object.assign(this.__state,{_$hasStarred:e,_$anonymousState__temp:t,_$anonymousState__temp2:n,_$anonymousState__temp3:o,_$anonymousState__temp4:r,loopArray22:_,loopArray23:c,$compid__100:s,$compid__101:u,$compid__102:l,banner:g}),this.__state}},{key:"anonymousFunc0",value:function(e){for(var t,n=arguments.length,o=Array(1<n?n-1:0),r=1;r<n;r++)o[r-1]=arguments[r];return this.anonymousFunc0Map[e]&&(t=this.anonymousFunc0Map)[e].apply(t,o)}}]),a}(),_class.$$events=[],_class.$$componentPath="pages/seckill/seckill",_temp2);exports.default=Seckill,Component(require("../../npm/@tarojs/taro-weapp/index.js").default.createComponent(Seckill,!0));