"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _class,_temp2,_extends=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e},_slicedToArray=function(e,r){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,r){var t=[],n=!0,o=!1,i=void 0;try{for(var a,s=e[Symbol.iterator]();!(n=(a=s.next()).done)&&(t.push(a.value),!r||t.length!==r);n=!0);}catch(e){o=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(o)throw i}}return t}(e,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")},_createClass=function(){function n(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,r,t){return r&&n(e.prototype,r),t&&n(e,t),e}}(),_get=function e(r,t,n){null===r&&(r=Function.prototype);var o=Object.getOwnPropertyDescriptor(r,t);if(void 0===o){var i=Object.getPrototypeOf(r);return null===i?void 0:e(i,t,n)}if("value"in o)return o.value;var a=o.get;return void 0!==a?a.call(n):void 0},_index=require("../../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_index3=require("../../npm/classnames/index.js"),_index4=_interopRequireDefault(_index3),_ajax=require("../../utils/ajax.js"),_ajax2=_interopRequireDefault(_ajax),_index5=require("../../utils/compatibility/index.js"),_orderDisplay=require("./order-display.js"),_orderStatus=require("./order-status.js"),_getOperationOfOrder=require("./get-operation-of-order.js"),_operationOfOrder=require("./operation-of-order.js"),_getOrderInfo=require("./get-order-info.js"),_getOrderInfo2=_interopRequireDefault(_getOrderInfo);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var s=e.apply(this,arguments);return new Promise(function(i,a){return function r(e,t){try{var n=s[e](t),o=n.value}catch(e){return void a(e)}if(!n.done)return Promise.resolve(o).then(function(e){r("next",e)},function(e){r("throw",e)});i(o)}("next")})}}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,r){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!r||"object"!=typeof r&&"function"!=typeof r?e:r}function _inherits(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function, not "+typeof r);e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),r&&(Object.setPrototypeOf?Object.setPrototypeOf(e,r):e.__proto__=r)}var Order=(_temp2=_class=function(e){function s(){var e,r,p,t,n=this;_classCallCheck(this,s);for(var o=arguments.length,i=Array(o),a=0;a<o;a++)i[a]=arguments[a];return(r=p=_possibleConstructorReturn(this,(e=s.__proto__||Object.getPrototypeOf(s)).call.apply(e,[this].concat(i)))).$usedState=["_$formContent","_$anonymousState__temp","anonymousState__temp2","loopArray9","$compid__40","$compid__41","$compid__42","$compid__43","$compid__44","$compid__45","$compid__46","$compid__47","$compid__48","$compid__49","$compid__50","$compid__51","$compid__52","orderStatus","modifiedGoodsList","orderType","orderInfo","tip","isVerification","operation","name","tel","postscript","shippingTypes","coupon","userInfoError","__fn_on"],p.config={navigationBarTitleText:"订单详情"},p.getData=(t=_asyncToGenerator(regeneratorRuntime.mark(function e(r){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",_getOrderInfo2.default.bind(p)(r));case 1:case"end":return e.stop()}},e,n)})),function(e){return t.apply(this,arguments)}),p.verify=_asyncToGenerator(regeneratorRuntime.mark(function e(){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=p.state.orderInfo,e.next=3,(0,_ajax2.default)({name:"verifyOrder",data:{orderId:r.order.id},hintText:"核销"});case 3:r.order.order_status=6,p.setState({orderInfo:r});case 5:case"end":return e.stop()}},e,n)})),p.handleClickActionButton=function(e){var r=p.state,t=r.orderInfo,n=r.coupon,o=r.name,i=r.tel,a=r.postscript,s=(0,_getOperationOfOrder.getOperation)(t&&t.order),d="main"===e?s.mainAction:s.minorAction;d&&d(t.order,{coupon:n,name:o,tel:i,postscript:a})},p.handleUserInfoChange=function(e){var r=_slicedToArray(e,3),t=r[0],n=r[1],o=r[2];p.setState({name:t,tel:n,postscript:o})},p.handleUserInfoError=function(e){p.setState({userInfoError:e[0]||""})},p.handleCouponChange=function(e,r){p.setState({orderInfo:e,coupon:r}),_index2.default.setStorageSync("coupon",r)},p.handleClickExpressCell=function(){(0,_operationOfOrder.viewExpressInfo)(p.state.orderInfo.order)},p.handleClickShowQRCode=function(){(0,_operationOfOrder.showQRCodeForVerifying)(p.state.orderInfo.order)},p.customComponents=["Header","Brick","HelperForTakingGoods","FormBuilder","GoodsCell","Regiment","ChooseShippingType","OrderCoupon","DataBlock","Tip","Loading","ActionBar","Price"],_possibleConstructorReturn(p,r)}return _inherits(s,_index.Component),_createClass(s,[{key:"_constructor",value:function(e){_get(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"_constructor",this).call(this,e),this.originalOrderInfo=null,this.state={orderInfo:null,name:"",tel:"",postscript:"",shippingTypes:null,tip:"",coupon:null,userInfoError:""},this.$$refs=[]}},{key:"componentWillMount",value:function(){var o=this,e=this.$router.params.id;_index2.default.hideShareMenu(),this.config=_index2.default.getStorageSync("config"),this.getData(!0),_index2.default.eventCenter.on("update:order",function(e){var r=1<arguments.length&&void 0!==arguments[1]&&arguments[1];if(e)if(e.pickingSite){var t=o.state.orderInfo;t.order.picking_site=e.pickingSite,o.setState({orderInfo:t})}else o.setState(e);r&&void 0!==e||o.getData(!0,{})}),_index2.default.eventCenter.on("updateAndPay:"+e,_asyncToGenerator(regeneratorRuntime.mark(function e(){var r,t,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.getData();case 2:r=e.sent,t=(0,_getOperationOfOrder.getOperation)(r&&r.order),(n=t.mainAction)&&n(r.order);case 6:case"end":return e.stop()}},e,o)})))}},{key:"onPullDownRefresh",value:function(){this.getData()}},{key:"componentDidShow",value:function(){var e=this.state.orderInfo;e?"未确认"===(0,_orderStatus.getStatus)(e.order)?_index2.default.setNavigationBarTitle({title:"确认订单"}):_index2.default.setNavigationBarTitle({title:"订单详情"}):"1"===this.$router.params.is_confirm&&_index2.default.setNavigationBarTitle({title:"确认订单"})}},{key:"onShareAppMessage",value:function(){var e=this.state.orderInfo;return e?(0,_index5.getGroupBookingShareContent)(e):null}},{key:"_createData",value:function(){var e,r;this.__state=arguments[0]||this.state||{},this.__props=arguments[1]||this.props||{};arguments[2];var n=this.$prefix,t=(0,_index.genCompid)(n+"$compid__40"),o=(0,_index.genCompid)(n+"$compid__41"),i=(0,_index.genCompid)(n+"$compid__42"),a=(0,_index.genCompid)(n+"$compid__43"),s=(0,_index.genCompid)(n+"$compid__44"),d=(0,_index.genCompid)(n+"$compid__45"),p=(0,_index.genCompid)(n+"$compid__46"),_=(0,_index.genCompid)(n+"$compid__47"),u=(0,_index.genCompid)(n+"$compid__48"),c=(0,_index.genCompid)(n+"$compid__49"),l=(0,_index.genCompid)(n+"$compid__50"),f=(0,_index.genCompid)(n+"$compid__51"),g=(0,_index.genCompid)(n+"$compid__52"),m=void 0,h=this.__state,y=h.orderInfo,x=h.coupon,v=h.shippingTypes,C=h.tip,$=h.name,O=h.tel,b=h.postscript,I=h.userInfoError,S="1"===this.$router.params.is_exchange,k=this.$router.params.scene,w="未知",j="",T=y&&(0,_orderStatus.getOrderType)(y.order),D=(0,_getOperationOfOrder.getOperation)(y&&y.order),M=(0,_orderDisplay.getDetailData)(y),R=[],A=y&&y.goodsInfo;y&&(w=(0,_orderStatus.getStatus)(y&&y.order),S=4===y.order.order_type,R=(0,_orderDisplay.getPriceData)(y),"未确认"===w&&(1!==y.order.shipping_type||y.order.picking_site&&y.order.picking_site.id?2===y.order.shipping_type&&0===y.order.address_id?j="请先创建一个收货地址":2!==y.order.shipping_type||0<y.order.address_id?-1===Number(y.order.shipping_fee)&&(j="当前地址不支持配送"):j="请选择一个收货地址":j="请选择自提点"),"拼团订单"===T?A=y.goodsInfo.map(function(e){return _extends({},e,{groupbooking_id:y.regimentInfo.groupbooking_id,regiment_id:y.order.regiment_id})}):S&&(A=y.goodsInfo.map(function(e){return _extends({},e,{points:y.order.pay_fee})}))),y?(e=[{isShow:0===y.order.shipping_type||1===y.order.shipping_type,label:"联系人",type:"input",value:$,required:!0,maxLength:5,minLength:2},{isShow:0===y.order.shipping_type||1===y.order.shipping_type,label:"手机号码",type:"tel",value:O,required:!0},{label:"备注",type:"textarea",value:b,maxLength:50}],r="未确认"===w?_index2.default.pxTransform(150):null,m=A.map(function(e,r){e={$original:(0,_index.internal_get_original)(e)};var t=(0,_index.genCompid)(n+"frnnDPVJCD"+r);return _index.propsManager.set({goods:e.$original,isExchange:S},t),{$compid__39:t,$original:e.$original}}),_index.propsManager.set({orderInfo:y,orderType:T,orderStatus:w,orderStatusText:w},t),_index.propsManager.set({orderInfo:y,orderStatus:w,isVerification:k,onShowExpress:this.handleClickExpressCell},o),("待收货"===w||"待提货"===w)&&_index.propsManager.set({orderInfo:y,isVerification:k,onShowQRCode:this.handleClickShowQRCode},i),"未确认"===w&&_index.propsManager.set({content:e,labelWidth:r,onChange:this.handleUserInfoChange,onError:this.handleUserInfoError},a),"拼团订单"===T&&y.regimentInfo&&_index.propsManager.set({regimentInfo:y.regimentInfo},s),"未确认"===w&&0!==y.order.shipping_type&&_index.propsManager.set({shippingTypes:v,orderInfo:y,orderStatus:w,onChange:this.getData},d),"普通订单"===T&&"未确认"===w&&_index.propsManager.set({orderInfo:y,coupon:x,originalOrderInfo:this.originalOrderInfo,onChange:this.handleCouponChange},p),_index.propsManager.set({dataList:R,type:S?"points":"price"},_),_index.propsManager.set({dataList:M},u)):C&&_index.propsManager.set({icon:"unhappy",text:C,mainActionType:"home",mainAction:"返回首页"},c);var q=(0,_index4.default)("order",{"display-action-bar":D||k&&"待提货"===w});return k&&"待提货"===w&&_index.propsManager.set({fixed:!0,mainButton:"核销订单",onClickMain:this.verify},l),(!k||"待提货"!==w)&&!k&&D&&_index.propsManager.set({fixed:!0,mainButton:D.mainButton,minorButton:D.minorButton,onClickMain:this.handleClickActionButton.bind(void 0,"main"),onClickMinor:this.handleClickActionButton.bind(void 0,"minor"),tip:j||I,disabled:"未确认"===w&&null===v||j},f),(!k||"待提货"!==w)&&!k&&D&&("未确认"===w||"待付款"===w)&&_index.propsManager.set({price:y.order.pay_fee,isExchange:S},g),Object.assign(this.__state,{_$formContent:e,_$anonymousState__temp:r,anonymousState__temp2:q,loopArray9:m,$compid__40:t,$compid__41:o,$compid__42:i,$compid__43:a,$compid__44:s,$compid__45:d,$compid__46:p,$compid__47:_,$compid__48:u,$compid__49:c,$compid__50:l,$compid__51:f,$compid__52:g,orderStatus:w,modifiedGoodsList:A,orderType:T,isVerification:k,operation:D}),this.__state}}]),s}(),_class.$$events=[],_class.$$componentPath="pages/order/order",_temp2);exports.default=Order,Component(require("../../npm/@tarojs/taro-weapp/index.js").default.createComponent(Order,!0));