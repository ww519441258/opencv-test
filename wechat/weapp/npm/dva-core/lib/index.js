"use strict";var _interopRequireWildcard=require("../../@babel/runtime/helpers/interopRequireWildcard.js"),_interopRequireDefault=require("../../@babel/runtime/helpers/interopRequireDefault.js");Object.defineProperty(exports,"__esModule",{value:!0}),exports.create=create;var _getIterator2=_interopRequireDefault(require("../../@babel/runtime/core-js/get-iterator.js")),_keys=_interopRequireDefault(require("../../@babel/runtime/core-js/object/keys.js")),_objectSpread2=_interopRequireDefault(require("../../@babel/runtime/helpers/objectSpread.js")),_redux=require("../../redux/lib/index.js"),_middleware=_interopRequireDefault(require("../../redux-saga/lib/internal/middleware.js")),_invariant=_interopRequireDefault(require("../../invariant/invariant.js")),_checkModel=_interopRequireDefault(require("./checkModel.js")),_prefixNamespace=_interopRequireDefault(require("./prefixNamespace.js")),_Plugin=_interopRequireWildcard(require("./Plugin.js")),_createStore=_interopRequireDefault(require("./createStore.js")),_getSaga=_interopRequireDefault(require("./getSaga.js")),_getReducer=_interopRequireDefault(require("./getReducer.js")),_createPromiseMiddleware=_interopRequireDefault(require("./createPromiseMiddleware.js")),_subscription=require("./subscription.js"),_utils=require("./utils.js"),dvaModel={namespace:"@@dva",state:0,reducers:{UPDATE:function(e){return e+1}}};function create(){var M=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},P=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},k=P.initialReducer,e=P.setupApp,A=void 0===e?_utils.noop:e,C=new _Plugin.default;C.use((0,_Plugin.filterHooks)(M));var N={_models:[(0,_prefixNamespace.default)((0,_objectSpread2.default)({},dvaModel))],_store:null,_plugin:C,use:C.use.bind(C),model:I,start:function(){var e=function(e,r){e&&("string"==typeof e&&(e=new Error(e)),e.preventDefault=function(){e._dontReject=!0},C.apply("onError",function(e){throw new Error(e.stack||e)})(e,N._store.dispatch,r))},r=(0,_middleware.default)(),t=(0,_createPromiseMiddleware.default)(N);N._getSaga=_getSaga.default.bind(null);var a=[],i=(0,_objectSpread2.default)({},k),u=!0,n=!1,s=void 0;try{for(var o,l=(0,_getIterator2.default)(N._models);!(u=(o=l.next()).done);u=!0){var c=o.value;i[c.namespace]=(0,_getReducer.default)(c.reducers,c.state,C._handleActions),c.effects&&a.push(N._getSaga(c.effects,c,e,C.get("onEffect")))}}catch(e){n=!0,s=e}finally{try{u||null==l.return||l.return()}finally{if(n)throw s}}var d=C.get("onReducer"),f=C.get("extraReducers");(0,_invariant.default)((0,_keys.default)(f).every(function(e){return!(e in i)}),"[app.start] extraReducers is conflict with other reducers, reducers list: ".concat((0,_keys.default)(i).join(", ")));var p=N._store=(0,_createStore.default)({reducers:E(),initialState:M.initialState||{},plugin:C,createOpts:P,sagaMiddleware:r,promiseMiddleware:t});p.runSaga=r.run,p.asyncReducers={};var _=C.get("onStateChange"),g=!0,v=!1,b=void 0;try{for(var m,q=function(){var e=m.value;p.subscribe(function(){e(p.getState())})},R=(0,_getIterator2.default)(_);!(g=(m=R.next()).done);g=!0)q()}catch(e){v=!0,b=e}finally{try{g||null==R.return||R.return()}finally{if(v)throw b}}a.forEach(r.run),A(N);var j={},y=!0,h=!1,S=void 0;try{for(var x,D=(0,_getIterator2.default)(this._models);!(y=(x=D.next()).done);y=!0){var w=x.value;w.subscriptions&&(j[w.namespace]=(0,_subscription.run)(w.subscriptions,w,N,e))}}catch(e){h=!0,S=e}finally{try{y||null==D.return||D.return()}finally{if(h)throw S}}function E(){return d((0,_redux.combineReducers)((0,_objectSpread2.default)({},i,f,N._store?N._store.asyncReducers:{})))}N.model=function(e,r,t,a){a=I(a);var i=N._store;i.asyncReducers[a.namespace]=(0,_getReducer.default)(a.reducers,a.state,C._handleActions),i.replaceReducer(e()),a.effects&&i.runSaga(N._getSaga(a.effects,a,r,C.get("onEffect")));a.subscriptions&&(t[a.namespace]=(0,_subscription.run)(a.subscriptions,a,N,r))}.bind(N,E,e,j),N.unmodel=function(e,r,t,a){var i=N._store;delete i.asyncReducers[a],delete r[a],i.replaceReducer(e()),i.dispatch({type:"@@dva/UPDATE"}),i.dispatch({type:"".concat(a,"/@@CANCEL_EFFECTS")}),(0,_subscription.unlisten)(t,a),N._models=N._models.filter(function(e){return e.namespace!==a})}.bind(N,E,i,j),N.replaceModel=function(e,r,t,a,i){var u=N._store,n=i.namespace,s=(0,_utils.findIndex)(N._models,function(e){return e.namespace===n});~s&&(u.dispatch({type:"".concat(n,"/@@CANCEL_EFFECTS")}),delete u.asyncReducers[n],delete r[n],(0,_subscription.unlisten)(t,n),N._models.splice(s,1));N.model(i),u.dispatch({type:"@@dva/UPDATE"})}.bind(N,E,i,j,e)}};return N;function I(e){var r=(0,_prefixNamespace.default)((0,_objectSpread2.default)({},e));return N._models.push(r),r}}