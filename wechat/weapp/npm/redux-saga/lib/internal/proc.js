"use strict";exports.__esModule=!0,exports.TASK_CANCEL=exports.CHANNEL_END=exports.NOT_ITERATOR_ERROR=void 0;var _extends=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};exports.default=proc;var _utils=require("./utils.js"),_scheduler=require("./scheduler.js"),_io=require("./io.js"),_channel=require("./channel.js"),_buffers=require("./buffers.js");function _defineEnumerableProperties(e,n){for(var t in n){var r=n[t];r.configurable=r.enumerable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,t,r)}return e}var NOT_ITERATOR_ERROR=exports.NOT_ITERATOR_ERROR="proc first argument (Saga function result) must be an iterator",CHANNEL_END=exports.CHANNEL_END={toString:function(){return"@@redux-saga/CHANNEL_END"}},TASK_CANCEL=exports.TASK_CANCEL={toString:function(){return"@@redux-saga/TASK_CANCEL"}},matchers={wildcard:function(){return _utils.kTrue},default:function(n){return"symbol"===(void 0===n?"undefined":_typeof(n))?function(e){return e.type===n}:function(e){return e.type===String(n)}},array:function(e){return function(n){return e.some(function(e){return matcher(e)(n)})}},predicate:function(n){return function(e){return n(e)}}};function matcher(e){return("*"===e?matchers.wildcard:_utils.is.array(e)?matchers.array:_utils.is.stringableFunc(e)?matchers.default:_utils.is.func(e)?matchers.predicate:matchers.default)(e)}function forkQueue(e,r,i){var c=[],o=void 0,a=!1;function u(e){t(),i(e,!0)}function n(t){c.push(t),t.cont=function(e,n){a||((0,_utils.remove)(c,t),t.cont=_utils.noop,n?u(e):(t===r&&(o=e),c.length||(a=!0,i(o))))}}function t(){a||(a=!0,c.forEach(function(e){e.cont=_utils.noop,e.cancel()}),c=[])}return n(r),{addTask:n,cancelAll:t,abort:u,getTasks:function(){return c},taskNames:function(){return c.map(function(e){return e.name})}}}function createTaskIterator(e){var n=e.context,t=e.fn,r=e.args;if(_utils.is.iterator(t))return t;var i,c,o=void 0,a=void 0;try{o=t.apply(n,r)}catch(e){a=e}return _utils.is.iterator(o)?o:a?(0,_utils.makeIterator)(function(){throw a}):(0,_utils.makeIterator)((i=void 0,c={done:!1,value:o},function(e){return i?{done:!0,value:e}:(i=!0,c)}))}var wrapHelper=function(e){return{fn:e}};function proc(r){var k=1<arguments.length&&void 0!==arguments[1]?arguments[1]:function(){return _utils.noop},S=2<arguments.length&&void 0!==arguments[2]?arguments[2]:_utils.noop,x=3<arguments.length&&void 0!==arguments[3]?arguments[3]:_utils.noop,e=4<arguments.length&&void 0!==arguments[4]?arguments[4]:{},s=5<arguments.length&&void 0!==arguments[5]?arguments[5]:{},i=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0,j=7<arguments.length&&void 0!==arguments[7]?arguments[7]:"anonymous",n=arguments[8];(0,_utils.check)(r,_utils.is.iterator,NOT_ITERATOR_ERROR);var L=(0,_utils.deprecate)(Q,(0,_utils.updateIncentive)("[...effects]","all([...effects])")),O=s.sagaMonitor,t=s.logger,c=s.onError,o=t||_utils.log,I=function(e){var n=e.sagaStack;!n&&e.stack&&(n=-1!==e.stack.split("\n")[0].indexOf(e.message)?e.stack:"Error: "+e.message+"\n"+e.stack),o("error","uncaught at "+j,n||e.message||e)},K=(0,_channel.stdChannel)(k),w=Object.create(e);h.cancel=_utils.noop;var a,u,l,f,_,d,v,H=(a=i,u=j,f=n,(l=r)._deferredEnd=null,(d={})[_utils.TASK]=!0,d.id=a,d.name=u,(v={})[_="done"]=v[_]||{},v[_].get=function(){if(l._deferredEnd)return l._deferredEnd.promise;var e=(0,_utils.deferred)();return l._deferredEnd=e,l._isRunning||(l._error?e.reject(l._error):e.resolve(l._result)),e.promise},d.cont=f,d.joiners=[],d.cancel=p,d.isRunning=function(){return l._isRunning},d.isCancelled=function(){return l._isCancelled},d.isAborted=function(){return l._isAborted},d.result=function(){return l._result},d.error=function(){return l._error},d.setContext=function(e){(0,_utils.check)(e,_utils.is.object,(0,_utils.createSetContextWarning)("task",e)),_utils.object.assign(w,e)},_defineEnumerableProperties(d,v),d),D={name:j,cancel:function(){D.isRunning&&!D.isCancelled&&(D.isCancelled=!0,h(TASK_CANCEL))},isRunning:!0},E=forkQueue(j,D,g);function p(){r._isRunning&&!r._isCancelled&&(r._isCancelled=!0,E.cancelAll(),g(TASK_CANCEL))}return n&&(n.cancel=p),r._isRunning=!0,h(),H;function h(e,n){if(!D.isRunning)throw new Error("Trying to resume an already finished generator");try{var t=void 0;(t=n?r.throw(e):e===TASK_CANCEL?(D.isCancelled=!0,h.cancel(),_utils.is.func(r.return)?r.return(TASK_CANCEL):{done:!0,value:TASK_CANCEL}):e===CHANNEL_END?_utils.is.func(r.return)?r.return():{done:!0}:r.next(e)).done?(D.isMainRunning=!1,D.cont&&D.cont(t.value)):q(t.value,i,"",h)}catch(e){D.isCancelled&&I(e),D.isMainRunning=!1,D.cont(e,!0)}}function g(n,t){r._isRunning=!1,K.close(),t?(n instanceof Error&&Object.defineProperty(n,"sagaStack",{value:"at "+j+" \n "+(n.sagaStack||n.stack),configurable:!0}),H.cont||(n instanceof Error&&c?c(n):I(n)),r._error=n,r._isAborted=!0,r._deferredEnd&&r._deferredEnd.reject(n)):(r._result=n,r._deferredEnd&&r._deferredEnd.resolve(n)),H.cont&&H.cont(n,t),H.joiners.forEach(function(e){return e.cb(n,t)}),H.joiners=null}function q(e,n){var t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"",r=arguments[3],i=(0,_utils.uid)();O&&O.effectTriggered({effectId:i,parentEffectId:n,label:t,effect:e});var c=void 0;function o(e,n){c||(c=!0,r.cancel=_utils.noop,O&&(n?O.effectRejected(i,e):O.effectResolved(i,e)),r(e,n))}o.cancel=_utils.noop,r.cancel=function(){if(!c){c=!0;try{o.cancel()}catch(e){I(e)}o.cancel=_utils.noop,O&&O.effectCancelled(i)}};var a,u,s,l,f,_,d,v,E,p,h,g,C,y,m,A,b,N,R,T=void 0;return _utils.is.promise(e)?P(e,o):_utils.is.helper(e)?F(wrapHelper(e),i,o):_utils.is.iterator(e)?M(e,i,j,o):_utils.is.array(e)?L(e,i,o):(T=_io.asEffect.take(e))?function(e,n){var t=e.channel,r=e.pattern,i=e.maybe;t=t||K;var c=function(e){return e instanceof Error?n(e,!0):(0,_channel.isEnd)(e)&&!i?n(CHANNEL_END):n(e)};try{t.take(c,matcher(r))}catch(e){return n(e,!0)}n.cancel=c.cancel}(T,o):(T=_io.asEffect.put(e))?(A=o,b=(m=T).channel,N=m.action,R=m.resolve,void(0,_scheduler.asap)(function(){var e=void 0;try{e=(b?b.put:S)(N)}catch(e){if(b||R)return A(e,!0);I(e)}if(!R||!_utils.is.promise(e))return A(e);P(e,A)})):(T=_io.asEffect.all(e))?Q(T,i,o):(T=_io.asEffect.race(e))?(E=T,p=i,h=o,g=void 0,C=Object.keys(E),y={},C.forEach(function(i){var e=function(e,n){if(!g)if(n)h.cancel(),h(e,!0);else if(!(0,_channel.isEnd)(e)&&e!==CHANNEL_END&&e!==TASK_CANCEL){var t;h.cancel(),g=!0;var r=((t={})[i]=e,t);h(_utils.is.array(E)?[].slice.call(_extends({},r,{length:C.length})):r)}};e.cancel=_utils.noop,y[i]=e}),h.cancel=function(){g||(g=!0,C.forEach(function(e){return y[e].cancel()}))},void C.forEach(function(e){g||q(E[e],p,e,y[e])})):(T=_io.asEffect.call(e))?function(e,n,t){var r=e.context,i=e.fn,c=e.args,o=void 0;try{o=i.apply(r,c)}catch(e){return t(e,!0)}return _utils.is.promise(o)?P(o,t):_utils.is.iterator(o)?M(o,n,i.name,t):t(o)}(T,i,o):(T=_io.asEffect.cps(e))?function(e,t){var n=e.context,r=e.fn,i=e.args;try{var c=function(e,n){return _utils.is.undef(e)?t(n):t(e,!0)};r.apply(n,i.concat(c)),c.cancel&&(t.cancel=function(){return c.cancel()})}catch(e){return t(e,!0)}}(T,o):(T=_io.asEffect.fork(e))?F(T,i,o):(T=_io.asEffect.join(e))?function(e,n){if(e.isRunning()){var t={task:H,cb:n};n.cancel=function(){return(0,_utils.remove)(e.joiners,t)},e.joiners.push(t)}else e.isAborted()?n(e.error(),!0):n(e.result())}(T,o):(T=_io.asEffect.cancel(e))?function(e,n){e===_utils.SELF_CANCELLATION&&(e=H);e.isRunning()&&e.cancel();n()}(T,o):(T=_io.asEffect.select(e))?function(e,n){var t=e.selector,r=e.args;try{var i=t.apply(void 0,[x()].concat(r));n(i)}catch(e){n(e,!0)}}(T,o):(T=_io.asEffect.actionChannel(e))?(f=o,_=(l=T).pattern,d=l.buffer,(v=matcher(_)).pattern=_,void f((0,_channel.eventChannel)(k,d||_buffers.buffers.fixed(),v))):(T=_io.asEffect.flush(e))?(s=o,void T.flush(s)):(T=_io.asEffect.cancelled(e))?void o(!!D.isCancelled):(T=_io.asEffect.getContext(e))?void o(w[T]):(T=_io.asEffect.setContext(e))?(a=T,u=o,_utils.object.assign(w,a),void u()):o(e)}function P(e,n){var t=e[_utils.CANCEL];_utils.is.func(t)?n.cancel=t:_utils.is.func(e.abort)&&(n.cancel=function(){return e.abort()}),e.then(n,function(e){return n(e,!0)})}function M(e,n,t,r){proc(e,k,S,x,w,s,n,t,r)}function F(e,n,t){var r=e.context,i=e.fn,c=e.args,o=e.detached,a=createTaskIterator({context:r,fn:i,args:c});try{(0,_scheduler.suspend)();var u=proc(a,k,S,x,w,s,n,i.name,o?null:_utils.noop);o?t(u):a._isRunning?(E.addTask(u),t(u)):a._error?E.abort(a._error):t(u)}finally{(0,_scheduler.flush)()}}function Q(r,n,i){var c=Object.keys(r);if(!c.length)return i(_utils.is.array(r)?[]:{});var o=0,a=void 0,u={},s={};c.forEach(function(t){var e=function(e,n){a||(n||(0,_channel.isEnd)(e)||e===CHANNEL_END||e===TASK_CANCEL?(i.cancel(),i(e,n)):(u[t]=e,++o===c.length&&(a=!0,i(_utils.is.array(r)?_utils.array.from(_extends({},u,{length:c.length})):u))))};e.cancel=_utils.noop,s[t]=e}),i.cancel=function(){a||(a=!0,c.forEach(function(e){return s[e].cancel()}))},c.forEach(function(e){return q(r[e],n,e,s[e])})}}